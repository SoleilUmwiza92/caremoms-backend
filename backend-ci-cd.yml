name: CareMoms Backend â€“ CI/CD Pipeline

# ============================================
# ğ—™ğ—¿ğ—¼ğ—º ğ—–ğ—¼ğ—±ğ—² ğ˜ğ—¼ ğ—£ğ—¿ğ—¼ğ—±ğ˜‚ğ—°ğ˜ğ—¶ğ—¼ğ—»
# Trigger pipeline on pushes & PRs to main
# ============================================
on:
  push:
    branches: ["main"]

permissions:
  contents: write
  security-events: write

jobs:
  # ============================================
  # ğŸ§ª ğ—§ğ—²ğ˜€ğ˜ ğ—Ÿğ—¶ğ—¸ğ—² ğ—® ğ—£ğ—¿ğ—¼ â€“ Build & Test Stage
  # Ensures code quality BEFORE deployment
  # ============================================
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”„ Checkout source code
        uses: actions/checkout@v4

      - name: ğŸ”§ Set up Java (Temurin 17)
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: ğŸ§ª Run Unit Tests
        run: mvn -B test

      - name: ğŸ“¦ Build JAR Artifact
        run: mvn -B package -DskipTests

      - name: â¬† Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar
          path: target/*.jar

  # ============================================
  # ğŸ›¡ï¸ ğ—¦ğ˜ğ—®ğ˜† ğ—¦ğ—®ğ—³ğ—² â€“ Security Scanning Stage
  # Runs static code analysis + container scanning
  # ============================================
  security-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- CodeQL: Static Application Security Testing (SAST) ---
      - name: ğŸ” Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: java

      - name: ğŸ›¡ Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

      # --- Trivy: Vulnerability Scanner ---
      - name: ğŸ“¥ Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install -y wget
          wget -qO- https://aquasecurity.github.io/trivy-repo/install.sh | sudo sh

      - name: ğŸ” Scan Dockerfile and Dependencies
        run: trivy config .

  # ============================================
  # ğŸ³ ğ—–ğ—¼ğ—»ğ˜ğ—®ğ—¶ğ—»ğ—²ğ—¿-ğ—¥ğ—²ğ—®ğ—±ğ˜† â€“ Docker Build Stage
  # Ensures image builds correctly before deploying
  # ============================================
  docker-build:
    needs: [build-and-test]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§± Enable Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ³ Build Docker image (local only)
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: caremoms-backend:latest

  # ============================================
  # ğŸš€ ğ—™ğ—¿ğ—¼ğ—º ğ—–ğ—¼ğ—±ğ—² ğ˜ğ—¼ ğ—£ğ—¿ğ—¼ğ—±ğ˜‚ğ—°ğ˜ğ—¶ğ—¼ğ—» â€“ Railway Deployment
  # Deploys automatically when all checks pass
  # ============================================
  deploy:
    needs: [build-and-test, security-scan, docker-build]
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Install Railway CLI
        run: npm install -g @railway/cli

      - name: ğŸš€ Deploy to Railway (Auto-Deploy)
        run: railway up --ci
        env:
          RAILWAY_TOKEN:b6fba28e-9786-4c72-961c-227b4db19d9d

